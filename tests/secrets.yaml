name: okms-cli secrets test suite
description: Test the OKMS secrets subcommand
testcases:
  - name: random-string
    steps:
    - script: echo {{randAlpha 8 | lower}}
      info: response time is {{.result.timeseconds}}
      vars:
        content:
          from: result.systemout


  - name: Create Secret
    steps:
      - name: Create a Secret
        type: okms-cmd
        args: secret create --cas-required=true --deactivate-version-after="1d" --max-versions=10 {{.random-string.content}} data=data
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldBeTrue
          - result.systemoutjson.metadata.current_version ShouldEqual '1'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldMatchRegex ^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$


  - name: Create an existing Secret
    steps:
      - name: Create an existing Secret
        type: okms-cmd
        args: secret create {{.random-string.content}} data=data
        assertions:
          - result.code ShouldEqual 1

  - name: Get Secret
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret get {{.random-string.content}} 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '1'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldMatchRegex ^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "data"
          - result.systemoutjson.version.id ShouldEqual "1"

  - name: Get Secret without data
    steps:
      - name: Get a Secret without data
        type: okms-cmd
        args: secret get {{.random-string.content}} --include-data=false
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '1'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldEqual "" 

  - name: Update the secret
    steps:
      - name: Update the secret 
        type: okms-cmd
        args: secret update {{.random-string.content}} --cas=1 data=new_data 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '2'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldBeEmpty

  - name: Get Secret
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret get {{.random-string.content}} 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '1'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "new_data"
          - result.systemoutjson.version.id ShouldEqual "1"

  - name: Create new version
    steps:
      - name: Update the secret and its metadata
        type: okms-cmd
        # We change cas_required and expect the result to be effective immediatly, so cas should not be required fot this 
        args: secret version create {{.random-string.content}} --cas=2 data=new_data_again 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "false" 
          - result.systemoutjson.metadata.current_version ShouldEqual '3'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""

  - name: Get Secret
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret get {{.random-string.content}} 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '3'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "new_data_again"
          - result.systemoutjson.version.id ShouldEqual "3"

  - name: Get Secret Version
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret version get {{.random-string.content}} --version=2
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '3'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "new_data"
          - result.systemoutjson.version.id ShouldEqual "2"

  - name: Get Secret
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret get {{.random-string.content}} --version=2
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '3'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "new_data"
          - result.systemoutjson.version.id ShouldEqual "2"


  - name: Update the secret's version state
    steps:
      - name: Update the secret's version state
        type: okms-cmd
        # We change cas_required and expect the result to be effective immediatly, so cas should not be required fot this 
        args: secret version update {{.random-string.content}} --state activated
        assertions:
          - result.code ShouldEqual 1

  - name: Update the secret's version state
    steps:
      - name: Update the secret's version state
        type: okms-cmd
        # We change cas_required and expect the result to be effective immediatly, so cas should not be required fot this 
        args: secret version update {{.random-string.content}} --state deactivated --version=3
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.created_at ShouldNotEqual ""
          - result.systemoutjson.deactivated_at ShouldNotEqual ""
          - result.systemoutjson.data ShouldEqual ""
          - result.systemoutjson.id ShouldEqual "3"
          - result.systemoutjson.version.id ShouldEqual "3"

  - name: Get Secret
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret get {{.random-string.content}} 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '3'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "yet_new_data"
          - result.systemoutjson.version.id ShouldEqual "3"


  - name: Update the secret and metadata
    steps:
      - name: Update the secret and its metadata
        type: okms-cmd
        # We change cas_required and expect the result to be effective immediatly, so cas should not be required fot this 
        args: secret update {{.random-string.content}} --cas-required=false data=yet_new_data 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "false" 
          - result.systemoutjson.metadata.current_version ShouldEqual '4'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""

  - name: Get Secret
    steps:
      - name: Get a Secret
        type: okms-cmd
        args: secret get {{.random-string.content}} 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.metadata.cas_required ShouldEqual "true" 
          - result.systemoutjson.metadata.current_version ShouldEqual '4'
          - result.systemoutjson.metadata.oldest_version ShouldEqual '0'
          - result.systemoutjson.metadata.deactivate_version_after ShouldEqual "1d"
          - result.systemoutjson.metadata.max_versions ShouldEqual "10"
          - result.systemoutjson.metadata.updated_at ShouldNotEqual ""
          - result.systemoutjson.version.created_at ShouldNotEqual ""
          - result.systemoutjson.version.data ShouldContainKey "data"
          - result.systemoutjson.version.data.data ShouldEqual "yet_new_data"
          - result.systemoutjson.version.id ShouldEqual "4"


  - name: Delete Secret
    steps:
      - name: Delete a Secret
        type: okms-cmd
        args: secret delete {{.random-string.content}}
        assertions:
          - result.code ShouldEqual 0
  
  - name: Secret config 
    steps: 
      - name: Update config 
        type: okms-cmd
        args: secret config update --deactivate-after="1d" --max-versions=24 
        assertions:
          - result.code ShouldEqual 0
      - name: Read config 
        type: okms-cmd
        args: secret config get 
        assertions:
          - result.code ShouldEqual 0
          - result.systemoutjson.deactivate-version-after ShouldEqual "1d"
          - result.systemoutjson.max-version ShouldEqual "24"
          
